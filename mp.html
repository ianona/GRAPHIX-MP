<html>

    <head>

        <script src="js/Box2dWeb.min.js"></script>
        <script src="js/three.js"></script>
        <script src="js/keyboard.js"></script>
        <script src="js/jquery.js"></script>
        <script src="js/maze.js"></script>
        <script src="js/PowerUp.js"></script>
        <script src="js/powerUpPlus.js"></script>

        <link rel="stylesheet" type="text/css" href="semantic/semantic.min.css">
        <script src="semantic/semantic.min.js"></script>

        <script>
            var gameState = undefined;

            // variables for gameplay
            var map = undefined;
            var difficultyLevel = undefined;
            var time = undefined;

            // variables for rendering
            var scene = undefined;
            var camera = undefined;
            var light = undefined;
            var ballMesh = undefined;
            var mazeMesh = undefined;
            var planeMesh = undefined;
            var camZoom = 20;

            // variables to model physics
            var maze = undefined;
            var mazeDimension  = 11;
            var ballRadius = 0.40;
            var keyAxis = [0, 0];
            var world = undefined;
            var ball = undefined;
            
            //For power ups
            var freeSpaces = [];
            var powerupSpaces = [];
            var powerUps = []; // list of powerup objects
            var ballSpeed = 0.95;
            var camZoomIncrement = 0;
            var extraIntensity = 0;

            // Box2D shortcuts
            var b2World        = Box2D.Dynamics.b2World,
                b2FixtureDef   = Box2D.Dynamics.b2FixtureDef,
                b2BodyDef      = Box2D.Dynamics.b2BodyDef,
                b2Body		   = Box2D.Dynamics.b2Body,
                b2CircleShape  = Box2D.Collision.Shapes.b2CircleShape,
                b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
                b2Settings     = Box2D.Common.b2Settings,
                b2Vec2         = Box2D.Common.Math.b2Vec2;

            function initPhysics() {
                // Create the world object.
                world = new b2World(new b2Vec2(0, 0), true);

                // Create the ball.
                var bodyDef = new b2BodyDef();
                bodyDef.type = b2Body.b2_dynamicBody;
                bodyDef.position.Set(1, 1);
                ball = world.CreateBody(bodyDef);

                var fixDef = new b2FixtureDef();
                fixDef.density = 1.0;
                fixDef.friction = 0.0;
                fixDef.restitution = 0.25;
                fixDef.shape = new b2CircleShape(ballRadius);
                ball.CreateFixture(fixDef);

                // Create the maze.
                bodyDef.type = b2Body.b2_staticBody;
                fixDef.shape = new b2PolygonShape();
                fixDef.shape.SetAsBox(0.5, 0.5);
                for (var i = 0; i < maze.dimension; i++) {
                    for (var j = 0; j < maze.dimension; j++) {
                        if (maze[i][j]) {
                            bodyDef.position.x = i;
                            bodyDef.position.y = j;
                            world.CreateBody(bodyDef).CreateFixture(fixDef);
                        }
                    }
                }
            }

            function initGraphics() {
                // Create the scene object.
                scene = new THREE.Scene();

                // Add the light.
                light= new THREE.PointLight(0xb7def2, .04);
                light.position.set(1, 1, 1.3);
                scene.add(light);

                // Add the ball.
                ballMesh = new THREE.Mesh(new THREE.SphereGeometry(ballRadius, 32, 16),
                                          new THREE.MeshPhongMaterial({color: 0xff0808,specular: 0xffffff, shininess: 30, flatShading:false}));
                ballMesh.position.set(1, 1, ballRadius);
                scene.add(ballMesh);

                // Add the camera.
                var aspect = window.innerWidth/window.innerHeight;
                camera = new THREE.PerspectiveCamera(50, aspect, 1, 1000);
                camera.position.set(1, 1, 5);
                scene.add(camera);

                // Add the maze.
                mazeMesh = generate_maze_mesh(maze);
                scene.add(mazeMesh);

                // Add the ground.
                //                planeTexture.wrapS = planeTexture.wrapT = THREE.RepeatWrapping;
                //                planeTexture.repeat.set(mazeDimension*5, mazeDimension*5);
                planeMesh = new THREE.Mesh(new THREE.PlaneGeometry(mazeDimension, mazeDimension, mazeDimension, mazeDimension),
                                           new THREE.MeshPhongMaterial({color: 0x7fd9a9,specular: 0xffffff, shininess: 30, flatShading:false}));
                planeMesh.position.set((mazeDimension-1)/2, (mazeDimension-1)/2, 0);
                planeMesh.rotation.set(Math.PI/2, 0, 0);
                scene.add(planeMesh);                
            }

            function generate_maze_mesh(field) {
                var dummy = new THREE.Geometry();
                for (var i = 0; i < field.dimension; i++) {
                    for (var j = 0; j < field.dimension; j++) {
                        if (field[i][j]) {
                            var geometry = new THREE.CubeGeometry(1,1,1,1,1,1);
                            var mesh_ij = new THREE.Mesh(geometry);
                            mesh_ij.position.x = i;
                            mesh_ij.position.y = j;
                            mesh_ij.position.z = 0.5;
                            THREE.GeometryUtils.merge(dummy, mesh_ij);
                        } else {
                            freeSpaces.push(i + ',' + j);
                        }
                    }
                }
                //                var material = new THREE.MeshPhongMaterial({map: brickTexture});
                var material = new THREE.MeshPhongMaterial({color: 0xa2632e,specular: 0xffffff, shininess: 30, flatShading:false});

                var mesh = new THREE.Mesh(dummy, material)
                return mesh;
            }

            function updatePhysics() {
                // Apply "friction". 
                var lv = ball.GetLinearVelocity();
//                if (ballSpeed != 0.95){
//                    console.log(ballSpeed);
//                }
                lv.Multiply(ballSpeed);
                ball.SetLinearVelocity(lv);

                // Apply user-directed force.
                var f = new b2Vec2(keyAxis[0]*ball.GetMass()*0.25, keyAxis[1]*ball.GetMass()*0.25);
                ball.ApplyImpulse(f, ball.GetPosition());          
                keyAxis = [0,0];

                // Take a time step.
                world.Step(1/60, 8, 3);
            }

            function updateGraphics() {
                // Update ball position.
                var stepX = ball.GetPosition().x - ballMesh.position.x;
                var stepY = ball.GetPosition().y - ballMesh.position.y;
                ballMesh.position.x += stepX;
                ballMesh.position.y += stepY;

                // Update ball rotation.
                var tempMat = new THREE.Matrix4();
                tempMat.makeRotationAxis(new THREE.Vector3(0,1,0), stepX/ballRadius);
                tempMat.multiplySelf(ballMesh.matrix);
                ballMesh.matrix = tempMat;
                tempMat = new THREE.Matrix4();
                tempMat.makeRotationAxis(new THREE.Vector3(1,0,0), -stepY/ballRadius);
                tempMat.multiplySelf(ballMesh.matrix);
                ballMesh.matrix = tempMat;
                ballMesh.rotation.getRotationFromMatrix(ballMesh.matrix);

                // Update camera with ball
                camera.position.x += (ballMesh.position.x - camera.position.x) * 0.1;
                camera.position.y += (ballMesh.position.y - camera.position.y) * 0.1;
                camera.position.z += (camZoom - camera.position.z) * 0.1;

                // Update light to focus on ball
                light.position.x = camera.position.x;
                light.position.y = camera.position.y;
                light.position.z = camera.position.z - 4;
            }

            function isHighscore(time){
                return false;
            }

            function gameLoop() {
                switch (gameState) {
                    case "initialize":
                        console.log("initializing game...")

                        maze = generateSquareMaze(mazeDimension);
                        maze[mazeDimension-1][mazeDimension-2] = false;
                        initPhysics();
                        initGraphics();
                        camera.position.set(1, 1, 5);
                        light.position.set(1, 1, 1.3);
                        light.intensity = 0;
                        var level = Math.floor((mazeDimension-1)/2 - 4);
                        $('#level').text(map.charAt(0).toUpperCase() + map.slice(1) + " (" + difficultyLevel.charAt(0).toUpperCase() + difficultyLevel.slice(1) + ")");
                        gameState = "fade in";
                        generatePowerUps(freeSpaces);
                        break;
                    case "fade in":
                        light.intensity += 0.1 * (1.0 - light.intensity);
                        renderer.render(scene, camera);
                        if (Math.abs(light.intensity - 1.0) < 0.05) {
                            light.intensity = .50;
                            gameState = "play";
                        }
                        break;
                    case 'play':
                        updatePhysics();
                        updateGraphics();
                        detectPowerupCollision()
                        renderer.render(scene, camera);
                        
                        // Check for victory.
                        var mazeX = Math.floor(ballMesh.position.x + 0.5);
                        var mazeY = Math.floor(ballMesh.position.y + 0.5);
                        if (mazeX == mazeDimension && mazeY == mazeDimension - 2) { 
                            //                            mazeDimension += 2;
                            //                            gameState = "fade out";
                            if (isHighscore(time)) {
                                $('div#highscoreModal').modal('show');
                            } else {
                                $('div#endgameModal').modal('show');
                            }
                        }
                        break;

                    case 'fade out':
                        updatePhysics();
                        updateGraphics();
                        light.intensity += 0.1 * (0.0 - light.intensity);
                        renderer.render(scene, camera);
                        if (Math.abs(light.intensity - 0.0) < 0.1) {
                            light.intensity = 0.0;
                            renderer.render(scene, camera);
                            gameState = "initialize";
                        }
                        break;
                }

                requestAnimationFrame(gameLoop);
            }

            function onMoveKey(axis) {
                keyAxis = axis.slice(0);
            }

            function onJumpKey(axis) {
                console.log("jumping")
            }

            function saveHighScore(time){

            }

            $(document).ready(function(){
                // Create the renderer
                renderer = new THREE.WebGLRenderer();
                renderer.setSize(window.innerWidth, window.innerHeight);
                //                    document.body.appendChild(renderer.domElement);
                $("div#canvas").append(renderer.domElement)

                // Bind keyboard controls
                KeyboardJS.bind.axis('left', 'right', 'down', 'up', onMoveKey);
                KeyboardJS.bind.key('spacebar', onJumpKey);
                $("div#canvas").hide();


                $("img").mouseenter(function(event){
                    $("div#map").text(event.target.dataset.map);
                })

                $("img").mouseleave(function(event){
                    $("div#map").text("Choose a map");
                })

                $("button").click(function(event){
                    $("button").removeClass("primary");
                    $(event.target).addClass("primary");
                })

                $("img").click(function(event){
                    map = event.target.dataset.map.toLowerCase()
                    difficultyLevel = $("button.primary").text().toLowerCase()
                    $("div.wrapper").hide()
                    $("div#canvas").show();
                    $("body").css("background","black");

                    //                    $("body").click(function(){
                    //                        console.log(camera)
                    //                        camZoom -= 5;
                    //                    })

                    gameState = "initialize";

                    // Start the game loop.
                    requestAnimationFrame(gameLoop);
                })

                $("div.exitBtn").click(function(event){
                    var tag = event.target.dataset.tag;
                    if (tag==="save"){
                        saveHighScore(69);
                    }
                    $("div.wrapper").show()
                    $("div#canvas").hide();
                    $("body").css("background","white");
                    gameState = undefined;
                })

                $("div.playBtn").click(function(event){
                    var tag = event.target.dataset.tag;
                    if (tag==="save"){
                        saveHighScore(69);
                    }
                    gameState = "initialize";
                })
            })

        </script>
        <style>
            body{
                margin: 0;
                padding: 0;
                height:100%;
                /*                background:black;*/
                overflow: hidden;
            }

            .wrapper{
                width:800px;
                height:100%;
                margin:0 auto;
                text-align: center;
                padding-top:100px;
            }

            .title{
                font-size:6em!important;
            }

            .subtitle{
                font-size:2em!important;
            }

            img:hover{
                cursor: pointer;
                width:220px!important;
            }

            img{
                width:200px!important;
                transition-property: all;
                transition-timing-function: ease-in;
                transition-duration: .2s;
            }

            .maps{
                margin-top:30px!important;
                margin-bottom:30px!important;
            }

            div#canvas{
                text-align: center;
                padding-top:20px;
            }
        </style>
    </head>
    <body>

        <div class="wrapper">
            <div class="ui huge header title">Ball Game</div>
            <div class="ui header subtitle" id="map">Choose a map</div>

            <div class="ui images maps">
                <img data-map="Jungle" class="ui medium rounded image" src="Mobile.jpg">
                <img data-map="Dungeon" class="ui medium rounded image" src="Mobile.jpg">
                <img data-map="Space" class="ui medium rounded image" src="Mobile.jpg">
            </div>

            <div class="ui header subtitle">Choose a difficulty level</div>
            <div class="three large ui buttons">
                <button class="primary ui button"><i class="smile outline icon"></i>Easy</button>
                <button class="ui button"><i class="meh outline icon"></i>Medium</button>
                <button class="ui button"><i class="frown outline icon"></i>Difficult</button>
            </div>
        </div>
        
        <div id="canvas">
            <div id="level" class="ui huge yellow header title">Level 1</div>      
        </div>

        <div class="ui basic modal" id="endgameModal">
            <div class="ui icon header">
                <i class="flag checkered icon"></i>
                Game Finished! Time: 69
            </div>
            <center>
                <div class="actions">
                    <div class="ui green ok inverted button playBtn">
                        <i class="redo icon"></i>
                        Play Again
                    </div>
                    <div class="ui red cancel inverted button exitBtn">
                        <i class="chevron circle left icon"></i>
                        Exit
                    </div>
                </div>
            </center>
        </div>

        <div class="ui basic modal" id="highscoreModal">
            <div class="ui icon header">
                <i class="flag checkered icon"></i>
                High Score! Time: 69
            </div>
            <center>
                <div class="ui input focus">
                    <input type="text" placeholder="Florante">
                </div>
                <form class="ui form">
                </form>
                <div class="actions">
                    <div data-tag="save" class="ui green ok inverted button playBtn">
                        <i class="redo icon"></i>
                        Save & Play Again
                    </div>
                    <div data-tag="save" class="ui red cancel inverted button exitBtn">
                        <i class="chevron circle left icon"></i>
                        Save & Exit
                    </div>
                </div>
            </center>
        </div>
    </body>
</html>

