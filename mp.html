<html>

    <head>

        <script src="js/Box2dWeb.min.js"></script>
        <script src="js/three.js"></script>
        <script src="js/keyboard.js"></script>
        <script src="js/jquery.js"></script>
        <script src="js/maze.js"></script>
        <script src="js/PowerUp.js"></script>
        <script src="js/GLTFLoader.js"></script>
        <script src="js/class/powerUpPlus.js"></script>
        <script src="js/class/HighScore.js"></script>

        <link rel="stylesheet" type="text/css" href="semantic/semantic.min.css">
        <script src="semantic/semantic.min.js"></script>

        <script>
            var gameState = undefined;

            // variables for gameplay
            var map = undefined;
            var difficultyLevel = undefined;
            var highscores = [];
            var timeVal = undefined;

            // variables for rendering
            var scene = undefined;
            var camera = undefined;
            var light = undefined;
            var ballMesh = undefined;
            var mazeMesh = undefined;
            var planeMesh = undefined;
            var camZoom = 20;
            var firstPerson = false;

            // variables to model physics
            var maze = undefined;
            var mazeDimension  = 11;
            var ballRadius = 0.40;
            var keyAxis = [0, 0];
            var world = undefined;
            var ball = undefined;

            //For power ups
            var freeSpaces = [];
            var powerupSpaces = [];
            var powerUps = []; // list of powerup objects
            var ballSpeed = 0.95;
            var camZoomIncrement = 0;
            
            // variables for textures
            var jungleFloor    = THREE.ImageUtils.loadTexture("assets/jungle_floor.jpg")
            var jungleWall    = THREE.ImageUtils.loadTexture("assets/jungle_wall.jpg")
            var dungeonFloor    = THREE.ImageUtils.loadTexture("assets/dungeon_floor.jpg")
            var dungeonWall    = THREE.ImageUtils.loadTexture("assets/dungeon_wall.jpg")
            var spaceFloor    = THREE.ImageUtils.loadTexture("assets/space_floor.png")
            var spaceWall    = THREE.ImageUtils.loadTexture("assets/space_wall.jpg")

            // Box2D shortcuts
            var b2World        = Box2D.Dynamics.b2World,
                b2FixtureDef   = Box2D.Dynamics.b2FixtureDef,
                b2BodyDef      = Box2D.Dynamics.b2BodyDef,
                b2Body		   = Box2D.Dynamics.b2Body,
                b2CircleShape  = Box2D.Collision.Shapes.b2CircleShape,
                b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
                b2Settings     = Box2D.Common.b2Settings,
                b2Vec2         = Box2D.Common.Math.b2Vec2;

            function initPhysics() {
                // Create the world object.
                world = new b2World(new b2Vec2(0, 0), true);

                // Create the ball.
                var bodyDef = new b2BodyDef();
                bodyDef.type = b2Body.b2_dynamicBody;
                bodyDef.position.Set(1, 1);
                ball = world.CreateBody(bodyDef);

                var fixDef = new b2FixtureDef();
                fixDef.density = 1.0;
                fixDef.friction = 0.0;
                fixDef.restitution = 0.25;
                fixDef.shape = new b2CircleShape(ballRadius);
                ball.CreateFixture(fixDef);

                // Create the maze.
                bodyDef.type = b2Body.b2_staticBody;
                fixDef.shape = new b2PolygonShape();
                fixDef.shape.SetAsBox(0.5, 0.5);
                for (var i = 0; i < maze.dimension; i++) {
                    for (var j = 0; j < maze.dimension; j++) {
                        if (maze[i][j]) {
                            bodyDef.position.x = i;
                            bodyDef.position.y = j;
                            world.CreateBody(bodyDef).CreateFixture(fixDef);
                        }
                    }
                }
            }

            function initGraphics() {
                // Create the scene object.
                scene = new THREE.Scene();

                // Add the light.
                light= new THREE.PointLight(0xb7def2, .04);
                light.position.set(1, 1, 1.3);
                scene.add(light);

                // Add the ball.
                ballMesh = new THREE.Mesh(new THREE.SphereGeometry(ballRadius, 32, 16),
                                          new THREE.MeshPhongMaterial({color: 0xff0808,specular: 0xffffff, shininess: 30, flatShading:false}));
                ballMesh.position.set(1, 1, ballRadius);
                scene.add(ballMesh);

                // Add the camera.
                var aspect = window.innerWidth/window.innerHeight;
                camera = new THREE.PerspectiveCamera(50, aspect, 1, 1000);
                camera.position.set(1, 1, 5);
                scene.add(camera);

                // Add the maze.
                mazeMesh = generate_maze_mesh(maze);
                scene.add(mazeMesh);

                // Add the ground.
                planeMesh = new THREE.Mesh(new THREE.PlaneGeometry(mazeDimension, mazeDimension, mazeDimension, mazeDimension),
                                           new THREE.MeshPhongMaterial({color: 0x7fd9a9,specular: 0xffffff, shininess: 30, flatShading:false}));
            
                planeMesh.position.set((mazeDimension-1)/2, (mazeDimension-1)/2, 0);
                planeMesh.rotation.set(Math.PI/2, 0, 0);
                scene.add(planeMesh);                
            }

            function initMap(){
                //                const objLoader = new THREE.OBJLoader()
                //                objLoader.setPath("/blender/")
                //                const mtlLoader = new THREE.MTLLoader()
                //                mtlLoader.setPath("/blender/")
                switch(map){
                    case "jungle":
                        console.log("loading...")
                        //                    new Promise((resolve)=>{
                        //                        mtlLoader.load("rockv1.mtl",(material)=>{
                        //                            resolve(material)
                        //                        })
                        //                    }).then((material)=>{
                        //                        material.preload()
                        //                    })
                        //                        var loader = new THREE.GLTFLoader();
            
                        planeMesh.material = new THREE.MeshPhongMaterial({map:jungleFloor,specular: 0xffffff, shininess: 30, flatShading:false})
                        mazeMesh.material = new THREE.MeshPhongMaterial({map:jungleWall,specular: 0xffffff, shininess: 30, flatShading:false,specular: 0xffffff, shininess: 30, flatShading:false})
                        break;
                        case "dungeon":
                         planeMesh.material = new THREE.MeshPhongMaterial({map:dungeonFloor,specular: 0xffffff, shininess: 30, flatShading:false})
                        mazeMesh.material = new THREE.MeshPhongMaterial({map:dungeonWall,specular: 0xffffff, shininess: 30, flatShading:false,specular: 0xffffff, shininess: 30, flatShading:false})
                        break;
                        case "space":
                        planeMesh.material = new THREE.MeshPhongMaterial({map:spaceFloor,specular: 0xffffff, shininess: 30, flatShading:false})
                        mazeMesh.material = new THREE.MeshPhongMaterial({map:spaceWall,specular: 0xffffff, shininess: 30, flatShading:false,specular: 0xffffff, shininess: 30, flatShading:false})
                        break;
                }
            }

            function generate_maze_mesh(field) {
                var dummy = new THREE.Geometry();
                for (var i = 0; i < field.dimension; i++) {
                    for (var j = 0; j < field.dimension; j++) {
                        if (field[i][j]) {
                            var geometry = new THREE.CubeGeometry(1,1,1,1,1,1);
                            var mesh_ij = new THREE.Mesh(geometry);
                            mesh_ij.position.x = i;
                            mesh_ij.position.y = j;
                            mesh_ij.position.z = 0.5;
                            THREE.GeometryUtils.merge(dummy, mesh_ij);
                        } else {
                            freeSpaces.push(i + ',' + j);
                        }
                    }
                }
                //                var material = new THREE.MeshPhongMaterial({map: brickTexture});
                var material = new THREE.MeshPhongMaterial({color: 0xa2632e,specular: 0xffffff, shininess: 30, flatShading:false});

                var mesh = new THREE.Mesh(dummy, material)
                return mesh;
            }

            function updatePhysics() {
                // Apply "friction". 
                var lv = ball.GetLinearVelocity();
                //                if (ballSpeed != 0.95){
                //                    console.log(ballSpeed);
                //                }
                lv.Multiply(ballSpeed);
                ball.SetLinearVelocity(lv);

                // Apply user-directed force.
                var f = new b2Vec2(keyAxis[0]*ball.GetMass()*0.25, keyAxis[1]*ball.GetMass()*0.25);
                ball.ApplyImpulse(f, ball.GetPosition());          
                keyAxis = [0,0];

                // Take a time step.
                world.Step(1/60, 8, 3);
            }

            function updateGraphics() {
                // Update ball position.
                var stepX = ball.GetPosition().x - ballMesh.position.x;
                var stepY = ball.GetPosition().y - ballMesh.position.y;
                ballMesh.position.x += stepX;
                ballMesh.position.y += stepY;

                // Update ball rotation.
                var tempMat = new THREE.Matrix4();
                tempMat.makeRotationAxis(new THREE.Vector3(0,1,0), stepX/ballRadius);
                tempMat.multiplySelf(ballMesh.matrix);
                ballMesh.matrix = tempMat;
                tempMat = new THREE.Matrix4();
                tempMat.makeRotationAxis(new THREE.Vector3(1,0,0), -stepY/ballRadius);
                tempMat.multiplySelf(ballMesh.matrix);
                ballMesh.matrix = tempMat;
                ballMesh.rotation.getRotationFromMatrix(ballMesh.matrix);

                if (firstPerson) {
                    camera.position.x += (ballMesh.position.x - camera.position.x) * 0.1;
                    //                    camera.position.y += (ballMesh.position.y - camera.position.y) * 0.1;
                    camera.position.y = ballMesh.position.y - (camZoom/2)
                    //                    camera.position.z += (camZoom - camera.position.z) * 0.1;
                    camera.position.z = 4
                    camera.rotation.set(1,0,0)
                    camera.up.set(0,0,1)

                    // Update light to focus on ball
                light.position.x = camera.position.x;
                light.position.y = camera.position.y;
                light.position.z = camera.position.z - 2
                light.rotation.set(3,0,0)
                } else {
                    // Update camera with ball
                    camera.rotation.set(0,0,0)
                    light.rotation.set(0,0,0)
                    camera.position.x += (ballMesh.position.x - camera.position.x) * 0.1;
                    camera.position.y += (ballMesh.position.y - camera.position.y) * 0.1;
                    camera.position.z += (camZoom - camera.position.z) * 0.1;

                    // Update light to focus on ball
                light.position.x = camera.position.x;
                light.position.y = camera.position.y;
                light.position.z = camera.position.z - 4;
                }

                
            }

            function isHighscore(score){
                var sample = highscores.filter(score=>score==undefined||score==null)
                if (sample.length > 0 || highscores.length < 5){
                    return true;
                } else if (highscores[4].getTime > score){
                    return true;
                } else 
                    return false;
            }

            function gameLoop() {
                switch (gameState) {
                    case "initialize":
                        console.log("initializing game...")
                        switch (difficultyLevel){
                            case 'easy':
                                mazeDimension  = 15;
                                camZoom = 10;
                                break;
                            case 'medium':
                                mazeDimension  = 23;
                                camZoom = 8;
                                break;
                            case 'difficult':
                                mazeDimension  = 31;
                                camZoom = 5;
                                break;
                        }
                        maze = generateSquareMaze(mazeDimension);
                        maze[mazeDimension-1][mazeDimension-2] = false;
                        initPhysics();
                        initGraphics();
                        initMap();
                        camera.position.set(1, 1, 5);
                        light.position.set(1, 1, 1.3);
                        light.intensity = 0;
//                        var level = Math.floor((mazeDimension-1)/2 - 4);
                        $('#level').text(map.charAt(0).toUpperCase() + map.slice(1) + " (" + difficultyLevel.charAt(0).toUpperCase() + difficultyLevel.slice(1) + ")");
                        gameState = "fade in";
                        switch (difficultyLevel){
                            case 'easy':
                                generatePowerUps(freeSpaces, 3);
                                break;
                            case 'medium':
                                generatePowerUps(freeSpaces, 7);
                                break;
                            case 'difficult':
                                generatePowerUps(freeSpaces, 10);
                                break;
                        }
                        clearTimer();
                        timer();
                        break;
                        
                    case "fade in":
                        light.intensity += 0.1 * (1.0 - light.intensity);
                        renderer.render(scene, camera);
                        if (Math.abs(light.intensity - 1.0) < 0.05) {
                            light.intensity = .50;
                            switch (difficultyLevel){
                                case 'easy':
                                    light.intensity = .50;
                                    break;
                                case 'medium':
                                    light.intensity = .40;
                                    break;
                                case 'difficult':
                                    light.intensity = .30;
                                    break;
                            }
                            gameState = "play";
                        }
                        break;
                    case 'play':
                        
                        updatePhysics();
                        updateGraphics();
                        detectPowerupCollision()
                        rotatePowerups()
                        renderer.render(scene, camera);

                        // Check for victory.
                        var mazeX = Math.floor(ballMesh.position.x + 0.5);
                        var mazeY = Math.floor(ballMesh.position.y + 0.5);
                        if (mazeX == mazeDimension && mazeY == mazeDimension - 2) { 
                            //                            mazeDimension += 2;
                            //                            gameState = "fade out";
                            timeVal = h1.textContent
                            if (isHighscore(timeVal)) {
                                $('div#highscoreModal').modal('show');
                                resetState()
                                resetTimer();
                                gameState = undefined;
                            } else {
                                $('div#endgameModal').modal('show');
                                resetState()
                                resetTimer();
                                gameState = undefined;
                            }
                        }
                        break;

                    case 'fade out':
                        updatePhysics();
                        updateGraphics();
                        light.intensity += 0.1 * (0.0 - light.intensity);
                        renderer.render(scene, camera);
                        if (Math.abs(light.intensity - 0.0) < 0.1) {
                            light.intensity = 0.0;
                            renderer.render(scene, camera);
                            gameState = "initialize";
                        }
                        break;
                }

                requestAnimationFrame(gameLoop);
            }

            function onMoveKey(axis) {
                keyAxis = axis.slice(0);
            }

            function onJumpKey(axis) {
                console.log("jumping")
                firstPerson = !firstPerson
                camera.position.set(1, 1, 5);
                // light.position.set(1, 1, 1.3);
                console.log(light)
            }

            function saveHighScore(){
                highscores.push(new HighScore(timeVal, $("input#highscoreName").val(), map, difficultyLevel))
                highscores.sort(function(a,b){return a.getTime()-b.getTime()})
                highscores.length = 5
            }

            $(document).ready(function(){
                // Create the renderer
                $("h1#timer").hide();
                $("h1#highscore").hide();
                renderer = new THREE.WebGLRenderer();
                renderer.setSize(window.innerWidth, window.innerHeight);
                //                    document.body.appendChild(renderer.domElement);
                $("div#canvas").append(renderer.domElement)

                // Bind keyboard controls
                KeyboardJS.bind.axis('left', 'right', 'down', 'up', onMoveKey);
                KeyboardJS.bind.key('spacebar', onJumpKey);
                $("div#canvas").hide();


                $("img").mouseenter(function(event){
                    $("div#map").text(event.target.dataset.map);
                })

                $("img").mouseleave(function(event){
                    $("div#map").text("Choose a map");
                })

                $("div.difficultyMenu button").click(function(event){
                    $("button").removeClass("primary");
                    $(event.target).addClass("primary");
                })

                $("img").click(function(event){
                    map = event.target.dataset.map.toLowerCase()
                    difficultyLevel = $("button.primary").text().toLowerCase()
                    $("div.wrapper").hide()
                    $("div#canvas").show();
                    $("body").css("background","black");
                    $("h1#timer").show();
                    //                    $("body").click(function(){
                    //                        console.log(camera)
                    //                        camZoom -= 5;
                    //                    })

                    gameState = "initialize";

                    // Start the game loop.
                    requestAnimationFrame(gameLoop);
                })

                $("div.exitBtn").click(function(event){
                    var tag = event.target.dataset.tag;
                    if (tag==="save"){
                        saveHighScore();
                    }

                    $("h1#timer").hide();
                    $("div.wrapper").show()
                    $("div#canvas").hide();
                    $("body").css("background","white");
                    gameState = undefined;   
                })

                $("div.playBtn").click(function(event){
                    var tag = event.target.dataset.tag;
                    if (tag==="save"){
                        saveHighScore();
                    }
                    gameState = "initialize";
                })

                $("button#highscoresBtn").click(function(event){
                    $("tbody.highscoresBody").empty()
                    console.log("HIGHSCORES: " + highscores.length)
                    if (highscores.length==0){
                        var row = document.createElement("tr");
                        var cell = document.createElement("td");
                        $(cell).text("NO HIGH SCORES")
                        $(cell).attr("colspan",3)
                        row.appendChild(cell)
                        $("tbody.highscoresBody").append(row)
                    }
                    for (var i = 0; i<highscores.length;i++){
                        console.log(highscores[i])
                        if (highscores[i] == undefined) {
                            $('div#highscoresModal').modal('show');
                            return;
                        }
                        var row = document.createElement("tr");
                        var name = document.createElement("td");
                        $(name).text(highscores[i].getName())
                        var map = document.createElement("td");
                        $(map).text(highscores[i].getMap() + " (" + highscores[i].getDifficulty() + ")")
                        var time = document.createElement("td");
                        $(time).text(highscores[i].getTime())
                        
                        row.appendChild(name)
                        row.appendChild(map)
                        row.appendChild(time)
                        $("tbody.highscoresBody").append(row)
                    }
                    $('div#highscoresModal').modal('show');
                })
            })

        </script>
        <style>
            body{
                margin: 0;
                padding: 0;
                height:100%;
                /*                background:black;*/
                overflow: hidden;
            }

            .wrapper{
                width:800px;
                height:100%;
                margin:0 auto;
                text-align: center;
                padding-top:100px;
            }

            .title{
                font-size:6em!important;
            }

            .subtitle{
                font-size:2em!important;
            }

            img:hover{
                cursor: pointer;
                width:220px!important;
            }

            img{
                width:200px!important;
                transition-property: all;
                transition-timing-function: ease-in;
                transition-duration: .2s;
            }

            .maps{
                margin-top:30px!important;
                margin-bottom:30px!important;
            }

            div#canvas{
                text-align: center;
                padding-top:20px;
            }

            div#highscoresModal{
                text-align:center;
            }

            button#highscoresBtn{
                margin-top:30px!important;
                float:left!important;
            }
        </style>
    </head>
    <body>
        <h1 style='color:white;' id='timer'><time>00:00:00</time></h1>
        <h1 style='color:black;' id='highscore'><time>00:00:00</time></h1>
        <div class="wrapper">
            <div class="ui huge header title">Ball Game</div>
            <div class="ui header subtitle" id="map">Choose a map</div>

            <div class="ui images maps">
                <img data-map="Jungle" class="ui medium rounded image" src="assets/jungle_menu.png">
                <img data-map="Dungeon" class="ui medium rounded image" src="assets/dungeon_menu.png">
                <img data-map="Space" class="ui medium rounded image" src="assets/space_menu.png">
            </div>

            <div class="ui header subtitle">Choose a difficulty level</div>
            <div class="three large ui buttons difficultyMenu">
                <button class="primary ui button"><i class="smile outline icon"></i>Easy</button>
                <button class="ui button"><i class="meh outline icon"></i>Medium</button>
                <button class="ui button"><i class="frown outline icon"></i>Difficult</button>
            </div>

            <button class="ui basic button" id="highscoresBtn">
  <i class="icon eye"></i>
  View High Scores
</button>
        </div>

        <div id="canvas">
            <div id="level" class="ui huge yellow header title">Level 1</div>     
            <div id="buff" class="ui yellow huge header subtitle"></div>  
        </div>

        <div class="ui basic modal" id="endgameModal">
            <div class="ui icon header" id='timeMessage'>
                <i class="flag checkered icon"></i>
                Game Finished! Time:
            </div>
            <center>
                <div class="actions">
                    <div class="ui green ok inverted button playBtn">
                        <i class="redo icon"></i>
                        Play Again
                    </div>
                    <div class="ui red cancel inverted button exitBtn">
                        <i class="chevron circle left icon"></i>
                        Exit
                    </div>
                </div>
            </center>
        </div>

        <div class="ui basic modal" id="highscoreModal">
            
            <div class="ui icon header" id='timeMessage2'>
                <div><i class="flag checkered icon"></i></div>
                High Score! Time:
            </div>
            <center>
                <div class="ui input focus">
                    <input type="text" placeholder="Florante" id="highscoreName">
                </div>
                <form class="ui form">
                </form>
                <div class="actions">
                    <div data-tag="save" class="ui green ok inverted button playBtn">
                        <i class="redo icon"></i>
                        Save & Play Again
                    </div>
                    <div data-tag="save" class="ui red cancel inverted button exitBtn">
                        <i class="chevron circle left icon"></i>
                        Save & Exit
                    </div>
                </div>
            </center>
        </div>

        <div class="tiny ui modal" id="highscoresModal">
  <div class="header">High Scores</div>
  <div class="content">
<table class="ui celled table">
  <thead>
    <tr><th>Name</th>
    <th>Map</th>
    <th>Time</th>
  </tr></thead>
  <tbody class="highscoresBody">
    <tr>
      <td data-label="Name">James</td>
      <td data-label="Age">24</td>
      <td data-label="Job">Engineer</td>
    </tr>
    <tr>
      <td data-label="Name">Jill</td>
      <td data-label="Age">26</td>
      <td data-label="Job">Engineer</td>
    </tr>
    <tr>
      <td data-label="Name">Elyse</td>
      <td data-label="Age">24</td>
      <td data-label="Job">Designer</td>
    </tr>
  </tbody>
</table>
  </div>
  <div class="actions">
    <div class="ui cancel button">Close</div>
  </div>
</div>
    </body>
    <script src="js/timer.js"></script>
</html>

