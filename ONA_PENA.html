<html>
    <title>Maze Game</title>
    <head>

        <script src="js/Box2dWeb.min.js"></script>
        <script src="js/three.js"></script>
        <script src="js/keyboard.js"></script>
        <script src="js/jquery.js"></script>
        <script src="js/maze.js"></script>
        <script src="js/class/PowerUp.js"></script>
        <script src="js/OBJLoader.js"></script>
        <script src="js/JSONLoader.js"></script>
        <script src="js/powerUpPlus.js"></script>
        <script src="js/class/HighScore.js"></script>

        <link rel="stylesheet" type="text/css" href="semantic/semantic.min.css">
        <script src="semantic/semantic.min.js"></script>

        <script>
            var gameState = undefined;

            // variables for gameplay
            var map = undefined;
            var difficultyLevel = undefined;
            var highscores = [];
            var timeVal = undefined;
            var A1 = undefined;
            var A2 = undefined;
            var A3 = undefined;

            // variables for rendering
            var scene = undefined;
            var camera = undefined;
            var light = undefined;
            var ballMesh = undefined;
            var mazeMesh = undefined;
            var planeMesh = undefined;
            var camZoom = 20;
            var firstPerson = false;
            var mapView = false

            // variables to model physics
            var maze = undefined;
            var mazeDimension  = 11;
            var ballRadius = 0.40;
            var keyAxis = [0, 0];
            var world = undefined;
            var ball = undefined;

            //For power ups
            var freeSpaces = [];
            var powerupSpaces = [];
            var powerUps = []; // list of powerup objects
            var ballSpeed = 0.95;
            //            var camZoomFPZ = 4;

            // variables for textures
            var jungleFloor    = THREE.ImageUtils.loadTexture("assets/jungle_floor.jpg")
            var jungleWall    = THREE.ImageUtils.loadTexture("assets/jungle_wall.jpg")
            var dungeonFloor    = THREE.ImageUtils.loadTexture("assets/dungeon_floor.jpg")
            var dungeonWall    = THREE.ImageUtils.loadTexture("assets/dungeon_wall.jpg")
            var spaceFloor    = THREE.ImageUtils.loadTexture("assets/space_floor.png")
            var spaceWall    = THREE.ImageUtils.loadTexture("assets/space_wall.jpg")
            var rockTexture1    = THREE.ImageUtils.loadTexture("assets/rock_texture2.jpg")

            // imported Blender meshes
            var rockMesh = undefined
            var treeMesh = undefined
            var torchMesh = undefined
            var rocketMesh = undefined
            
            // Box2D shortcuts
            var b2World        = Box2D.Dynamics.b2World,
                b2FixtureDef   = Box2D.Dynamics.b2FixtureDef,
                b2BodyDef      = Box2D.Dynamics.b2BodyDef,
                b2Body		   = Box2D.Dynamics.b2Body,
                b2CircleShape  = Box2D.Collision.Shapes.b2CircleShape,
                b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
                b2Settings     = Box2D.Common.b2Settings,
                b2Vec2         = Box2D.Common.Math.b2Vec2;

            function initPhysics() {
                // Create the world object.
                world = new b2World(new b2Vec2(0, 0), true);

                // Create the ball.
                var bodyDef = new b2BodyDef();
                bodyDef.type = b2Body.b2_dynamicBody;
                bodyDef.position.Set(1, 1);
                ball = world.CreateBody(bodyDef);

                var fixDef = new b2FixtureDef();
                fixDef.density = 1.0;
                fixDef.friction = 0.0;
                fixDef.restitution = 0.25;
                fixDef.shape = new b2CircleShape(ballRadius);
                ball.CreateFixture(fixDef);

                // Create the maze.
                bodyDef.type = b2Body.b2_staticBody;
                fixDef.shape = new b2PolygonShape();
                fixDef.shape.SetAsBox(0.5, 0.5);
                for (var i = 0; i < maze.dimension; i++) {
                    for (var j = 0; j < maze.dimension; j++) {
                        if (maze[i][j]) {
                            bodyDef.position.x = i;
                            bodyDef.position.y = j;
                            world.CreateBody(bodyDef).CreateFixture(fixDef);
                        }
                    }
                }
            }

            function initGraphics() {
                // Create the scene object.
                scene = new THREE.Scene();

                // Add the light.
                light= new THREE.PointLight(0xb7def2, .04);
                light.position.set(1, 1, 1.3);
                scene.add(light);

                // Add the ball.
                ballMesh = new THREE.Mesh(new THREE.SphereGeometry(ballRadius, 32, 16),
                                          new THREE.MeshPhongMaterial({color: 0xff0808,specular: 0xffffff, shininess: 30, flatShading:false}));
                ballMesh.position.set(1, 1, ballRadius);
                scene.add(ballMesh);

                // Add the camera.
                var aspect = window.innerWidth/window.innerHeight;
                camera = new THREE.PerspectiveCamera(50, aspect, 1, 1000);
                camera.position.set(1, 1, 5);
                scene.add(camera);

                // Add the maze.
                mazeMesh = generate_maze_mesh(maze);
                scene.add(mazeMesh);

                // Add the ground.
                planeMesh = new THREE.Mesh(new THREE.PlaneGeometry(mazeDimension, mazeDimension, mazeDimension, mazeDimension),
                                           new THREE.MeshPhongMaterial({color: 0x7fd9a9,specular: 0xffffff, shininess: 30, flatShading:false}));

                planeMesh.position.set((mazeDimension-1)/2, (mazeDimension-1)/2, 0);
                planeMesh.rotation.set(Math.PI/2, 0, 0);
                scene.add(planeMesh);                
            }

            function initMap(){

                switch(map){
                    case "jungle":

                        for (var i=0;i<mazeDimension;i++){
                            var leftMesh = new THREE.Mesh(rockMesh)
                            leftMesh.material = new THREE.MeshPhongMaterial({map:rockTexture1,specular: 0xffffff, shininess: 30, flatShading:false})
                            leftMesh.rotation.x=90
                            if (Math.random() < 0.5){
                                leftMesh.position.set(-1,i,.5)
                                leftMesh.rotation.y = 90
                            } else {
                                leftMesh.position.set(-1,i,.5)
                                leftMesh.rotation.y = -90
                            }
                            scene.add(leftMesh);
                            var topMesh = new THREE.Mesh(rockMesh)
                            topMesh.material = new THREE.MeshPhongMaterial({map:rockTexture1,specular: 0xffffff, shininess: 30, flatShading:false})
                            topMesh.rotation.x=90
                            topMesh.position.set(i,mazeDimension+.5,.5)
                            if (Math.random() < 0.5){
                                topMesh.rotation.y = 180
                            } 
                            scene.add(topMesh);

                            var rightMesh = new THREE.Mesh(rockMesh)
                            rightMesh.material = new THREE.MeshPhongMaterial({map:rockTexture1,specular: 0xffffff, shininess: 30, flatShading:false})
                            rightMesh.rotation.x=90
                            if (Math.random() < 0.5){
                                rightMesh.rotation.y = 90
                                rightMesh.position.set(mazeDimension,i,.5)

                            } else {
                                rightMesh.rotation.y = -90
                                rightMesh.position.set(mazeDimension+.5,i,.5)

                            }
                            if (i <= mazeDimension - 4) scene.add(rightMesh);

                        }


                        treeMesh.material = new THREE.MeshPhongMaterial({map:rockTexture1,specular: 0xffffff, shininess: 30, flatShading:false})
                        treeMesh.rotation.x = 90

                        for (var i=0;i<mazeDimension;i++){
                            if (Math.random() < 0.4){
                                var branchMesh = new THREE.Mesh(treeMesh.children[1].geometry,new THREE.MeshPhongMaterial({color:0x5a3b24,specular: 0xffffff, shininess: 30, flatShading:false}))
                                branchMesh.position.set(-1,i,0)
                                branchMesh.rotation.x = 90
                                scene.add(branchMesh);

                                var leafMesh = new THREE.Mesh(treeMesh.children[2].geometry,new THREE.MeshPhongMaterial({color:0x398933,specular: 0xffffff, shininess: 30, flatShading:false}))
                                leafMesh.position.set(-1,i,0)
                                leafMesh.rotation.x = 90
                                scene.add(leafMesh);

                                var branchMesh2 = new THREE.Mesh(treeMesh.children[1].geometry,new THREE.MeshPhongMaterial({color:0x5a3b24,specular: 0xffffff, shininess: 30, flatShading:false}))
                                branchMesh2.position.set(i,mazeDimension+1,0)
                                branchMesh2.rotation.x = 90
                                scene.add(branchMesh2);

                                var leafMesh2 = new THREE.Mesh(treeMesh.children[2].geometry,new THREE.MeshPhongMaterial({color:0x398933,specular: 0xffffff, shininess: 30, flatShading:false}))
                                leafMesh2.position.set(i,mazeDimension+1,0)
                                leafMesh2.rotation.x = 90
                                scene.add(leafMesh2);

                                var branchMesh3 = new THREE.Mesh(treeMesh.children[1].geometry,new THREE.MeshPhongMaterial({color:0x5a3b24,specular: 0xffffff, shininess: 30, flatShading:false}))
                                branchMesh3.position.set(mazeDimension,i,0)
                                branchMesh3.rotation.x = 90

                                var leafMesh3 = new THREE.Mesh(treeMesh.children[2].geometry,new THREE.MeshPhongMaterial({color:0x398933,specular: 0xffffff, shininess: 30, flatShading:false}))
                                leafMesh3.position.set(mazeDimension,i,0)
                                leafMesh3.rotation.x = 90

                                if (i <= mazeDimension - 4) {
                                    scene.add(branchMesh3);
                                    scene.add(leafMesh3);

                                }
                            } 
                        }
                        //                            for ( var i = 0, l = object.children.length; i < l; i ++ ) {
                        //                                object.children[ i ].material = new THREE.MeshPhongMaterial({map:rockTexture1,specular: 0xffffff, shininess: 30, flatShading:false})
                        //
                        //                            }


                        planeMesh.material = new THREE.MeshPhongMaterial({map:jungleFloor,specular: 0xffffff, shininess: 30, flatShading:false})
                        mazeMesh.material = new THREE.MeshPhongMaterial({map:jungleWall,specular: 0xffffff, shininess: 30, flatShading:false})
                        break;
                    case "dungeon":
                        torchMesh.rotation.x = 90
                        for (var i=0;i<mazeDimension;i++){
                            if (i%2==0 && i <= mazeDimension - 3) {
                                generateTorch(i,torchMesh);
                            }
                        }
                        
                        planeMesh.material = new THREE.MeshPhongMaterial({map:dungeonFloor,specular: 0xffffff, shininess: 30, flatShading:false})
                        mazeMesh.material = new THREE.MeshPhongMaterial({map:dungeonWall,specular: 0xffffff, shininess: 30, flatShading:false})
                        break;
                    case "space":
                        console.log(rocketMesh)
                        var textures = [spaceFloor,rockTexture1,spaceWall]
                        for (var i=0;i<mazeDimension;i++){
                            if (i%5==0 && i <= mazeDimension - 3) {
                                generateRocket(-1,i,1.5,Math.floor(Math.random()*180) + 1,0)
                                generateRocket(mazeDimension,i,1.5,Math.floor(Math.random()*90) + 1,0)
                                generateRocket(i,mazeDimension,1.5,0,Math.floor(Math.random()*45))
                            }
                            if (i%6==0 && i <= mazeDimension - 3) {
                                generatePlanet(0,i,4,textures[Math.floor(Math.random() * textures.length)])
                                generatePlanet(mazeDimension,i,4,textures[Math.floor(Math.random() * textures.length)])
                                generatePlanet(i,mazeDimension,4,textures[Math.floor(Math.random() * textures.length)])
                            }
                        }
                        
                        planeMesh.material = new THREE.MeshPhongMaterial({map:spaceFloor,specular: 0xffffff, shininess: 30, flatShading:false})
                        mazeMesh.material = new THREE.MeshPhongMaterial({map:spaceWall,specular: 0xffffff, shininess: 30, flatShading:false})
                        break;
                }
            }
            
            function generatePlanet(x,y,z,texture){
                var planetMesh = new THREE.Mesh(new THREE.SphereGeometry(.5,32,32),new THREE.MeshPhongMaterial({map:texture,specular: 0xffffff, shininess: 30, flatShading:false}))
                                planetMesh.position.set(x,y,z)
                                scene.add(planetMesh)
            }
            
            function generateRocket(x,y,z,rX,rZ){
                // new THREE.MeshPhongMaterial({color:0x653e17,specular: 0xffffff, shininess: 30, flatShading:false})
                var windowMesh = new THREE.Mesh(rocketMesh.children[1].geometry,new THREE.MeshPhongMaterial({color:0x2078b9,specular: 0xffffff, shininess: 30, flatShading:false}))
                windowMesh.rotation.x = rX
                windowMesh.rotation.z = rZ
                windowMesh.position.set(x,y,z)
                scene.add(windowMesh);
                
                var tipMesh = new THREE.Mesh(rocketMesh.children[2].geometry,new THREE.MeshPhongMaterial({color:0xdb3d3d,specular: 0xffffff, shininess: 30, flatShading:false}))
                tipMesh.rotation.x = rX
                tipMesh.rotation.z = rZ
                tipMesh.position.set(x,y,z)
                scene.add(tipMesh);
                
                var bodyMesh = new THREE.Mesh(rocketMesh.children[3].geometry,new THREE.MeshPhongMaterial({color:0xffffff,specular: 0xffffff, shininess: 30, flatShading:false}))
                bodyMesh.rotation.x = rX
                bodyMesh.rotation.z = rZ
                bodyMesh.position.set(x,y,z)
                scene.add(bodyMesh);
            }

            function generateTorch(index,torchMesh){
                var handleMesh = new THREE.Mesh(torchMesh.children[3].geometry,new THREE.MeshPhongMaterial({color:0x653e17,specular: 0xffffff, shininess: 30, flatShading:false}))
                handleMesh.position.set(0,index,.4)
                handleMesh.rotation.x = 90
                scene.add(handleMesh);

                var ringMesh = new THREE.Mesh(torchMesh.children[2].geometry,new THREE.MeshPhongMaterial({color:0x2f2f2f,specular: 0xffffff, shininess: 30, flatShading:false}))
                ringMesh.position.set(0,index,.4)
                ringMesh.rotation.x = 90
                scene.add(ringMesh);

                var fireMesh = new THREE.Mesh(torchMesh.children[1].geometry,new THREE.MeshPhongMaterial({color:0xd11515,specular: 0xffffff, shininess: 30, flatShading:false}))
                fireMesh.position.set(0,index,.4)
                fireMesh.rotation.x = 90
                scene.add(fireMesh);

                var handleMesh2 = new THREE.Mesh(torchMesh.children[3].geometry,new THREE.MeshPhongMaterial({color:0x653e17,specular: 0xffffff, shininess: 30, flatShading:false}))
                handleMesh2.position.set(index,mazeDimension-1,.4)
                handleMesh2.rotation.x = 90
                scene.add(handleMesh2);

                var ringMesh2 = new THREE.Mesh(torchMesh.children[2].geometry,new THREE.MeshPhongMaterial({color:0x2f2f2f,specular: 0xffffff, shininess: 30, flatShading:false}))
                ringMesh2.position.set(index,mazeDimension-1,.4)
                ringMesh2.rotation.x = 90
                scene.add(ringMesh2);

                var fireMesh2 = new THREE.Mesh(torchMesh.children[1].geometry,new THREE.MeshPhongMaterial({color:0xd11515,specular: 0xffffff, shininess: 30, flatShading:false}))
                fireMesh2.position.set(index,mazeDimension-1,.4)
                fireMesh2.rotation.x = 90
                scene.add(fireMesh2);

                var handleMesh3 = new THREE.Mesh(torchMesh.children[3].geometry,new THREE.MeshPhongMaterial({color:0x653e17,specular: 0xffffff, shininess: 30, flatShading:false}))
                handleMesh3.position.set(mazeDimension-1,index,.4)
                handleMesh3.rotation.x = 90
                scene.add(handleMesh3);

                var ringMesh3 = new THREE.Mesh(torchMesh.children[2].geometry,new THREE.MeshPhongMaterial({color:0x2f2f2f,specular: 0xffffff, shininess: 30, flatShading:false}))
                ringMesh3.position.set(mazeDimension-1,index,.4)
                ringMesh3.rotation.x = 90
                scene.add(ringMesh3);

                var fireMesh3 = new THREE.Mesh(torchMesh.children[1].geometry,new THREE.MeshPhongMaterial({color:0xd11515,specular: 0xffffff, shininess: 30, flatShading:false}))
                fireMesh3.position.set(mazeDimension-1,index,.4)
                fireMesh3.rotation.x = 90
                scene.add(fireMesh3);

                var handleMesh4 = new THREE.Mesh(torchMesh.children[3].geometry,new THREE.MeshPhongMaterial({color:0x653e17,specular: 0xffffff, shininess: 30, flatShading:false}))
                handleMesh4.position.set(index,0,.4)
                handleMesh4.rotation.x = 90
                scene.add(handleMesh4);

                var ringMesh4 = new THREE.Mesh(torchMesh.children[2].geometry,new THREE.MeshPhongMaterial({color:0x2f2f2f,specular: 0xffffff, shininess: 30, flatShading:false}))
                ringMesh4.position.set(index,0,.4)
                ringMesh4.rotation.x = 90
                scene.add(ringMesh4);

                var fireMesh4 = new THREE.Mesh(torchMesh.children[1].geometry,new THREE.MeshPhongMaterial({color:0xd11515,specular: 0xffffff, shininess: 30, flatShading:false}))
                fireMesh4.position.set(index,0,.4)
                fireMesh4.rotation.x = 90
                scene.add(fireMesh4);
            }

            function generate_maze_mesh(field) {
                var dummy = new THREE.Geometry();
                for (var i = 0; i < field.dimension; i++) {
                    for (var j = 0; j < field.dimension; j++) {
                        if (field[i][j]) {
                            var geometry = new THREE.CubeGeometry(1,1,1,1,1,1);
                            var mesh_ij = new THREE.Mesh(geometry);
                            mesh_ij.position.x = i;
                            mesh_ij.position.y = j;
                            mesh_ij.position.z = 0.5;
                            THREE.GeometryUtils.merge(dummy, mesh_ij);
                        } else {
                            freeSpaces.push(i + ',' + j);
                        }
                    }
                }
                //                var material = new THREE.MeshPhongMaterial({map: brickTexture});
                var material = new THREE.MeshPhongMaterial({color: 0xa2632e,specular: 0xffffff, shininess: 30, flatShading:false});

                var mesh = new THREE.Mesh(dummy, material)
                return mesh;
            }

            function updatePhysics() {
                // Apply "friction". 
                var lv = ball.GetLinearVelocity();
                //                if (ballSpeed != 0.95){
                //                    console.log(ballSpeed);
                //                }
                lv.Multiply(ballSpeed);
                ball.SetLinearVelocity(lv);

                // Apply user-directed force.
                var f = new b2Vec2(keyAxis[0]*ball.GetMass()*0.25, keyAxis[1]*ball.GetMass()*0.25);
                ball.ApplyImpulse(f, ball.GetPosition());          
                keyAxis = [0,0];

                // Take a time step.
                world.Step(1/60, 8, 3);
            }

            function updateGraphics() {
                // Update ball position.
                var stepX = ball.GetPosition().x - ballMesh.position.x;
                var stepY = ball.GetPosition().y - ballMesh.position.y;
                ballMesh.position.x += stepX;
                ballMesh.position.y += stepY;

                // Update ball rotation.
                var tempMat = new THREE.Matrix4();
                tempMat.makeRotationAxis(new THREE.Vector3(0,1,0), stepX/ballRadius);
                tempMat.multiplySelf(ballMesh.matrix);
                ballMesh.matrix = tempMat;
                tempMat = new THREE.Matrix4();
                tempMat.makeRotationAxis(new THREE.Vector3(1,0,0), -stepY/ballRadius);
                tempMat.multiplySelf(ballMesh.matrix);
                ballMesh.matrix = tempMat;
                ballMesh.rotation.getRotationFromMatrix(ballMesh.matrix);

                if (mapView){
                    switch (difficultyLevel){
                        case 'easy':
                            camera.position.z = 35;
                            break;
                        case 'medium':
                            camera.position.z = 55;
                            break;
                        case 'difficult':
                            camera.position.z = 70;
                            break;
                    }
                    return
                }
                if (firstPerson) {
                    camera.position.x += (ballMesh.position.x - camera.position.x) * 0.1;
                    //                    camera.position.y += (ballMesh.position.y - camera.position.y) * 0.1;
                    //                    camera.position.z += (camZoom - camera.position.z) * 0.1;
                    switch (difficultyLevel){
                        case 'easy':
                            camera.position.y = ballMesh.position.y - (10/2)
                            camera.position.z = 4;
                            break;
                        case 'medium':
                            camera.position.y = ballMesh.position.y - (8/2)
                            camera.position.z = 3;
                            break;
                        case 'difficult':
                            camera.position.y = ballMesh.position.y - (5/2)
                            camera.position.z = 2;
                            break;
                    }
                    camera.rotation.set(1,0,0)
                    camera.up.set(0,0,1)

                    // Update light to focus on ball
                    light.position.x = camera.position.x;
                    light.position.y = camera.position.y;
                    light.position.z = camera.position.z - 2
                    light.rotation.set(3,0,0)
                } else {
                    // Update camera with ball
                    camera.rotation.set(0,0,0)
                    light.rotation.set(0,0,0)
                    camera.position.x += (ballMesh.position.x - camera.position.x) * 0.1;
                    camera.position.y += (ballMesh.position.y - camera.position.y) * 0.1;
                    camera.position.z += (camZoom - camera.position.z) * 0.1;

                    // Update light to focus on ball
                    light.position.x = camera.position.x;
                    light.position.y = camera.position.y;
                    light.position.z = camera.position.z - 4;
                }
            }

            function isHighscore(score){
                var sample = highscores.filter(score=>score==undefined||score==null)
                if (sample.length > 0 || highscores.length < 5){
                    return true;
                } else if (highscores[4].getTime > score){
                    return true;
                } else 
                    return false;
            }

            function gameLoop() {
                switch (gameState) {
                    case "initialize":
                        playMusic(map);
                        console.log("initializing game...")
                        switch (difficultyLevel){
                            case 'easy':
                                mazeDimension  = 15;
                                camZoom = 10;
                                break;
                            case 'medium':
                                mazeDimension  = 23;
                                camZoom = 8;
                                break;
                            case 'difficult':
                                mazeDimension  = 31;
                                camZoom = 5;
                                break;
                        }
                        //                        camZoom=30
                        maze = generateSquareMaze(mazeDimension);
                        maze[mazeDimension-1][mazeDimension-2] = false;
                        initPhysics();
                        initGraphics();
                        initMap();
                        camera.position.set(1, 1, 5);
                        light.position.set(1, 1, 1.3);
                        light.intensity = 0;
                        //                        var level = Math.floor((mazeDimension-1)/2 - 4);
                        $('#level').text(map.charAt(0).toUpperCase() + map.slice(1) + " (" + difficultyLevel.charAt(0).toUpperCase() + difficultyLevel.slice(1) + ")");
                        gameState = "fade in";
                        switch (difficultyLevel){
                            case 'easy':
                                generatePowerUps(freeSpaces, 3);
                                break;
                            case 'medium':
                                generatePowerUps(freeSpaces, 7);
                                break;
                            case 'difficult':
                                generatePowerUps(freeSpaces, 10);
                                break;
                        }
                        clearTimer();
                        timer();
                        break;

                    case "fade in":
                        light.intensity += 0.1 * (1.0 - light.intensity);
                        renderer.render(scene, camera);
                        if (Math.abs(light.intensity - 1.0) < 0.05) {
                            light.intensity = .50;
                            switch (difficultyLevel){
                                case 'easy':
                                    light.intensity = .50;
                                    break;
                                case 'medium':
                                    light.intensity = .40;
                                    break;
                                case 'difficult':
                                    light.intensity = .30;
                                    break;
                            }
                            gameState = "play";
                        }
                        break;
                    case 'play':
//                        console.log(camZoom);
                        updatePhysics();
                        updateGraphics();
                        detectPowerupCollision()
                        rotatePowerups()
                        renderer.render(scene, camera);

                        // Check if ball has exited maze
                        var mazeX = Math.floor(ballMesh.position.x + 0.5);
                        var mazeY = Math.floor(ballMesh.position.y + 0.5);
                        if (mazeX == mazeDimension && mazeY == mazeDimension - 2) { 
                            timeVal = h1.textContent
                            if (isHighscore(timeVal)) {
                                $('div#highscoreModal').modal('show');
                                resetState()
                                resetTimer();
                                gameState = undefined;
                            } else {
                                $('div#endgameModal').modal('show');
                                resetState()
                                resetTimer();
                                gameState = undefined;
                            }
                        }
                        break;
                    case 'fade out':
                        updatePhysics();
                        updateGraphics();
                        light.intensity += 0.1 * (0.0 - light.intensity);
                        renderer.render(scene, camera);
                        if (Math.abs(light.intensity - 0.0) < 0.1) {
                            light.intensity = 0.0;
                            renderer.render(scene, camera);
                            gameState = "initialize";
                        }
                        break;
                }

                requestAnimationFrame(gameLoop);
            }

            function onMoveKey(axis) {
                if (!mapView)
                keyAxis = axis.slice(0);
            }

            function onJumpKey(axis) {
                console.log("jumping")
                firstPerson = !firstPerson
                camera.position.set(1, 1, 5);
                // light.position.set(1, 1, 1.3);
                console.log(light)
            }

            function saveHighScore(){
                highscores.push(new HighScore(timeVal, $("input#highscoreName").val(), map, difficultyLevel))
                highscores.sort(function(a,b){return a.getTime()-b.getTime()})
                if (highscores.length > 5){
                    highscores.length = 5
                }
            }

            function playMusic(mapVal){
                switch (mapVal){
                    case 'jungle':
                        A1.play()
                        break;
                    case 'dungeon':
                        A2.play()
                        break;
                    case 'space':
                        A3.play();
                        break;
                }
            }

            function stopMusic(){
                A1.pause();
                A2.pause();
                A3.pause();
                A1.currentTime = 0;
                A2.currentTime = 0;
                A3.currentTime = 0;
            }

            function updateLoader(){
                if (treeMesh!=undefined && rockMesh!=undefined && torchMesh!=undefined && rocketMesh!=undefined) {
                    $("div#loader").remove()
                }
            }

            function toggleMapView(){
                if (firstPerson) return
                mapView = !mapView
                if (mapView){
                    KeyboardJS.unbind.key('spacebar')
                    console.log(KeyboardJS)
                    light.intensity = 3
                } else {
                    KeyboardJS.bind.key('spacebar', onJumpKey);
                    switch (difficultyLevel){
                        case 'easy':
                            light.intensity = .50;
                            break;
                        case 'medium':
                            light.intensity = .40;
                            break;
                        case 'difficult':
                            light.intensity = .30;
                            break;
                    }
                }
            }

            $(document).ready(function(){
                var loader = new THREE.JSONLoader();
                var loader2 = new THREE.OBJLoader();
                // Load blender
                loader.load("blender/rockv1.js", function (rock1Geometry) {
                    rockMesh = rock1Geometry
                    console.log("Loaded: BLENDER Rock")
                    updateLoader()
                } );

                loader2.load( "blender/tree.obj", function (mesh) {
                    treeMesh = mesh;
                    console.log("Loaded: BLENDER Tree")
                    updateLoader()
                });

                loader2.load( "blender/torch.obj", function (mesh) {
                    torchMesh = mesh
                    console.log("Loaded: BLENDER Torch")
                    updateLoader()
                });
                
                loader2.load( "blender/rocket.obj", function (mesh) {
                    rocketMesh = mesh
                    console.log("Loaded: BLENDER Rocket")
                    updateLoader()
                });

                A1 = document.getElementById("jungle_Audio");
                A2 = document.getElementById("dungeon_Audio");
                A3 = document.getElementById("space_Audio");
                A1.pause();
                A2.pause();
                A3.pause();
                // Create the renderer
                $("h1#timer").hide();
                $("h1#highscore").hide();
                renderer = new THREE.WebGLRenderer();
                renderer.setSize(window.innerWidth, window.innerHeight);
                //                    document.body.appendChild(renderer.domElement);
                $("div#canvas").append(renderer.domElement)

                // Bind keyboard controls
                KeyboardJS.bind.axis('left', 'right', 'down', 'up', onMoveKey);
                KeyboardJS.bind.key('spacebar', onJumpKey);
                KeyboardJS.bind.key('m', toggleMapView);
                $("div#canvas").hide();


                $("img").mouseenter(function(event){
                    $("div#map").text(event.target.dataset.map);
                })

                $("img").mouseleave(function(event){
                    $("div#map").text("Choose a map");
                })

                $("div.difficultyMenu button").click(function(event){
                    $("button").removeClass("primary");
                    $(event.target).addClass("primary");
                })

                $("img").click(function(event){
                    map = event.target.dataset.map.toLowerCase()
                    difficultyLevel = $("button.primary").text().toLowerCase()
                    $("div.wrapper").hide()
                    $("div#canvas").show();
                    $("body").css("background","black");
                    $("h1#timer").show();
                    //                    $("body").click(function(){
                    //                        console.log(camera)
                    //                        camZoom -= 5;
                    //                    })

                    gameState = "initialize";

                    // Start the game loop.
                    requestAnimationFrame(gameLoop);
                })

                $("div.exitBtn").click(function(event){
                    var tag = event.target.dataset.tag;
                    if (tag==="save"){
                        saveHighScore();
                    }

                    $("h1#timer").hide();
                    $("div.wrapper").show()
                    $("div#canvas").hide();
                    $("body").css("background","white");
                    gameState = undefined;
                    stopMusic()
                })

                $("div.playBtn").click(function(event){
                    var tag = event.target.dataset.tag;
                    if (tag==="save"){
                        saveHighScore();
                    }
                    gameState = "initialize";
                })

                $("button#highscoresBtn").click(function(event){
                    $("tbody.highscoresBody").empty()
                    console.log("HIGHSCORES: " + highscores.length)
                    if (highscores.length==0){
                        var row = document.createElement("tr");
                        var cell = document.createElement("td");
                        $(cell).text("NO HIGH SCORES")
                        $(cell).attr("colspan",3)
                        row.appendChild(cell)
                        $("tbody.highscoresBody").append(row)
                    }
                    for (var i = 0; i<highscores.length;i++){
                        console.log(highscores[i])
                        if (highscores[i] == undefined) {
                            $('div#highscoresModal').modal('show');
                            return;
                        }
                        var row = document.createElement("tr");
                        var name = document.createElement("td");
                        $(name).text(highscores[i].getName())
                        var map = document.createElement("td");
                        $(map).text(highscores[i].getMap() + " (" + highscores[i].getDifficulty() + ")")
                        var time = document.createElement("td");
                        $(time).text(highscores[i].getTime())

                        row.appendChild(name)
                        row.appendChild(map)
                        row.appendChild(time)
                        $("tbody.highscoresBody").append(row)
                    }
                    $('div#highscoresModal').modal('show');
                })
            })

        </script>
        <style>
            body{
                margin: 0;
                padding: 0;
                height:100%;
                /*                background:black;*/
                overflow: hidden;
            }

            .wrapper{
                width:800px;
                height:100%;
                margin:0 auto;
                text-align: center;
                padding-top:60px;
            }

            .title{
                font-size:6em!important;
            }

            .subtitle{
                font-size:2em!important;
            }

            img:hover{
                cursor: pointer;
                width:220px!important;
            }

            img{
                width:200px!important;
                transition-property: all;
                transition-timing-function: ease-in;
                transition-duration: .2s;
            }

            .maps{
                margin-top:30px!important;
                margin-bottom:30px!important;
            }

            div#canvas{
                text-align: center;
                padding-top:20px;
            }

            div#highscoresModal{
                text-align:center;
            }

            button#highscoresBtn{
                margin-top:30px!important;
                float:left!important;
            }
        </style>
    </head>
    <body>
        <audio loop id="jungle_Audio" src="assets/JUNGLE_MUSIC1.mp3" preload="auto">
        </audio>    
        <audio loop id="dungeon_Audio" src="assets/DUNGEON_MUSIC.mp3" preload="auto">
        </audio>
        <audio loop id="space_Audio" src="assets/SPACE_MUSIC.mp3" preload="auto">
        </audio>
        <h1 style='color:white;' id='timer'><time>00:00:00</time></h1>
        <h1 style='color:black;' id='highscore'><time>00:00:00</time></h1>
        <div class="wrapper">
            <div class="ui huge header title">Ball Game</div>
            <div class="ui header subtitle" id="map">Choose a map</div>
            <div class="ui segment">
                <div class="ui active dimmer" id="loader">
                    <div class="ui text loader" >Loading Assets...</div>

                </div>
                <div class="ui images maps">
                    <img data-map="Jungle" class="ui medium rounded image" src="assets/jungle_menu.png">
                    <img data-map="Dungeon" class="ui medium rounded image" src="assets/dungeon_menu.png">
                    <img data-map="Space" class="ui medium rounded image" src="assets/space_menu.png">
                </div>
                <p></p>
            </div>


            <div class="ui header subtitle">Choose a difficulty level</div>
            <div class="three large ui buttons difficultyMenu">
                <button class="primary ui button"><i class="smile outline icon"></i>Easy</button>
                <button class="ui button"><i class="meh outline icon"></i>Medium</button>
                <button class="ui button"><i class="frown outline icon"></i>Difficult</button>
            </div>

            <button class="ui basic button" id="highscoresBtn">
                <i class="icon eye"></i>
                View High Scores
            </button>
        </div>

        <div id="canvas">
            <div id="level" class="ui huge yellow header title">Level 1</div>     
            <div id="buff" class="ui yellow huge header subtitle"></div>  
        </div>

        <div class="ui basic modal" id="endgameModal">
            <div class="ui icon header" id='timeMessage'>
                <i class="flag checkered icon"></i>
                Game Finished! Time:
            </div>
            <center>
                <div class="actions">
                    <div class="ui green ok inverted button playBtn">
                        <i class="redo icon"></i>
                        Play Again
                    </div>
                    <div class="ui red cancel inverted button exitBtn">
                        <i class="chevron circle left icon"></i>
                        Exit
                    </div>
                </div>
            </center>
        </div>

        <div class="ui basic modal" id="highscoreModal">

            <div class="ui icon header" id='timeMessage2'>
                <div><i class="flag checkered icon"></i></div>
                High Score! Time:
            </div>
            <center>
                <div class="ui input focus">
                    <input type="text" placeholder="Florante" id="highscoreName">
                </div>
                <form class="ui form">
                </form>
                <div class="actions">
                    <div data-tag="save" class="ui green ok inverted button playBtn">
                        <i class="redo icon"></i>
                        Save & Play Again
                    </div>
                    <div data-tag="save" class="ui red cancel inverted button exitBtn">
                        <i class="chevron circle left icon"></i>
                        Save & Exit
                    </div>
                </div>
            </center>
        </div>

        <div class="tiny ui modal" id="highscoresModal">
            <div class="header">High Scores</div>
            <div class="content">
                <table class="ui celled table">
                    <thead>
                        <tr><th>Name</th>
                            <th>Map</th>
                            <th>Time</th>
                        </tr></thead>
                    <tbody class="highscoresBody">
                        <tr>
                            <td data-label="Name">James</td>
                            <td data-label="Age">24</td>
                            <td data-label="Job">Engineer</td>
                        </tr>
                        <tr>
                            <td data-label="Name">Jill</td>
                            <td data-label="Age">26</td>
                            <td data-label="Job">Engineer</td>
                        </tr>
                        <tr>
                            <td data-label="Name">Elyse</td>
                            <td data-label="Age">24</td>
                            <td data-label="Job">Designer</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="actions">
                <div class="ui cancel button">Close</div>
            </div>
        </div>
    </body>
    <script src="js/timer.js"></script>
</html>

